# %%
import getml
from challenge.utils.data import load_ctu_dataset

getml.set_project("{{ project_name }}")

# %% [markdown]
# # Task: {{ dataset }}
# ### Dataset Description
# > <span style="font-weight: 500; color: #3b3b3b;">ⓘ️&nbsp; Generated by `gpt-4o`</span>
# >
# > {{ dataset_description.split("\n") | join("\n> ") }}
#
# ### Tables
# Population table: {{ population_name }}
#
# <h4>
#   <details open>
#      <summary>ER Diagram</summary>
#        <img src="{{ dataset_er_diagram_url }}" alt="{{ dataset }} ER Diagram">
#    </details>
# </h4>

# %% [markdown]
# To load the dataset, we use the `load_ctu_dataset` function from the `utils`
# module. This function returns a tuple with the population table as the first
# element and the a dictionary of peripheral tables as the second element.

# %%
{{ population_name }}, peripheral = load_ctu_dataset("{{ dataset }}")

(
    {{ peripheral_names | join(",\n    ") }},
) = peripheral.values()

# %% [markdown]
# Now, we can inspect all tables and annotate the columns with [roles](https://getml.com/latest/user_guide/concepts/annotating_data/).

# %% [markdown]
# The population table (`{{ population_name }}`).
{% if task_type != "multiclass" %}
# We already set the `target` role for the target (`{{ target_column }}`).
{% elif task_type == "multiclass" %}
# As {{target_column }} has more than two levels, you are dealing with a multiclass classification problem. To work on multiclass tasks in the
# feature learning context, getML trains a separate model for each level of the target column in a one-vs-all fashion. To encode the target column
# this way, we provide a helper function [`getml.data.make_target_columns`](https://getml.com/latest/reference/data/#getml.data.make_target_columns). For
# a concrete example on that matter, please refere to the [CORA notebook](https://getml.com/latest/examples/enterprise-notebooks/cora/#12-prepare-data-for-getml).
{% endif %}
{% if task_type == "classification" %}
# {{ target_column }} is the target column for a binary classification task.
{% elif task_type == "regression" %}
# {{ target_column }} is the target column for a regression task.
{% endif %}

# %%
# TODO: Annotate remaining columns with roles
{{ population_name }}

# %% [markdown]
# Peripheral tables,

{% for table in peripheral_names %}
# %%
# TODO: Annotate columns with roles
{{ table }}
{% endfor %}

# %% [markdown]
# The next step is to define the data model. Refer to [https://relational.fel.cvut.cz/dataset/{{ dataset }}](https://relational.fel.cvut.cz/dataset/{{ dataset }})
# for a description of the dataset.

# %%
dm = getml.data.DataModel(population={{ population_name }}.to_placeholder())
dm.add(getml.data.to_placeholder(**peripheral))

# TODO
# dm.population.join(...)

# %% [markdown]
# Now we can create the container and add the tables to it.

# %%
container = getml.data.Container(population={{ population_name }}, split={{ population_name }}.split)
container.add(**peripheral)

container
